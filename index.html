<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深空收藏艙 | 獵人週邊管理 (雲端共用版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .dragging { opacity: 0.5; transform: scale(0.95); box-shadow: 0 0 0 2px #3b82f6; z-index: 50; }
        .cursor-move { cursor: grab; }
        .cursor-move:active { cursor: grabbing; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .thin-scrollbar::-webkit-scrollbar { width: 4px; }
        .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .thin-scrollbar::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 20px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, writeBatch, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useRef, memo } = React;

        // ==========================================
        // --- 請在此處填入您的 Firebase 設定 ---
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDxpH_rteE6PJq_bMmg3X2CxTs1lrQmhZA",
            authDomain: "deepspace-collection.firebaseapp.com",
            projectId: "deepspace-collection",
            storageBucket: "deepspace-collection.firebasestorage.app",
            messagingSenderId: "129454784064",
            appId: "1:129454784064:web:38e7f8ffcf99d9a61ea9a5",
            measurementId: "G-GCCS7NBT15"
        };

        const GLOBAL_APP_ID = "deepspace_shared_v1";

        // --- 初始化 Firebase ---
        let auth, db;
        let isFirebaseInitialized = false;

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseInitialized = true;
                console.log("Firebase initialized successfully.");
            } catch (e) { console.error("Firebase init error:", e); }
        } else if (typeof __firebase_config !== 'undefined') {
            try {
                const app = initializeApp(JSON.parse(__firebase_config));
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseInitialized = true;
            } catch(e) { console.log("Preview env init failed", e); }
        }

        const CHARACTERS = ["沈星回", "黎深", "祁煜", "秦徹", "夏以晝"];
        const DEFAULT_MERCH_TYPES = [
            "徽章", "立牌", "拍立得", "小卡", "相卡", "明信片", "雷射票", "書籤", 
            "透卡", "貼紙", "色紙", "簽名板", "杯墊", "吊飾", "公仔", "娃娃", "卡冊", "其他"
        ];

        const CHARACTER_THEMES = {
            "沈星回": { bg: "bg-purple-50", text: "text-purple-700", border: "border-purple-200", badge: "bg-purple-100 text-purple-800" },
            "黎深": { bg: "bg-slate-50", text: "text-slate-700", border: "border-slate-200", badge: "bg-slate-100 text-slate-800" },
            "祁煜": { bg: "bg-pink-50", text: "text-pink-700", border: "border-pink-200", badge: "bg-pink-100 text-pink-800" },
            "秦徹": { bg: "bg-red-50", text: "text-red-700", border: "border-red-200", badge: "bg-red-100 text-red-800" },
            "夏以晝": { bg: "bg-orange-50", text: "text-orange-700", border: "border-orange-200", badge: "bg-orange-100 text-orange-800" },
            "其他": { bg: "bg-gray-50", text: "text-gray-700", border: "border-gray-200", badge: "bg-gray-100 text-gray-800" }
        };

        // --- Components Defined Outside App ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                const container = containerRef.current;
                if (!container || !window.lucide) return;
                container.innerHTML = '';
                const iconNode = window.lucide.icons[name];
                if (iconNode) {
                    const svgElement = window.lucide.createElement(iconNode);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    if (className) svgElement.setAttribute('class', className);
                    svgElement.setAttribute('stroke-width', 2);
                    container.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };

        const FilterBar = memo(({ options, selected, toggle, multi, highlightSet }) => (
            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide animate-fade-in items-center">
                <button 
                    onClick={() => toggle('all')}
                    className={`px-3 py-1 text-xs rounded-full whitespace-nowrap transition-colors border ${selected.length === 0 ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                >
                    {multi ? "全選" : "全部"}
                </button>
                {options.map(opt => {
                    const isHighlight = highlightSet && highlightSet.has(opt);
                    return (
                        <button 
                            key={opt}
                            onClick={() => toggle(opt)}
                            className={`px-3 py-1 text-xs rounded-full whitespace-nowrap transition-colors border 
                                ${selected.includes(opt) 
                                    ? 'bg-blue-100 text-blue-700 border-blue-300' 
                                    : (isHighlight ? 'bg-yellow-50 text-yellow-700 border-yellow-200 hover:bg-yellow-100' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50')
                                }`}
                        >
                            {opt}
                        </button>
                    );
                })}
                {multi && <button onClick={() => toggle('all')} className="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-600 border border-transparent hover:bg-gray-300 whitespace-nowrap">重置</button>}
            </div>
        ));

        const StackCard = memo(({ stack, index, isDraggable, handleDragStart, handleDragEnter, handleDragEnd, handleMoveStack, openModal, deleteFromCollection }) => {
            const theme = CHARACTER_THEMES[stack.character] || CHARACTER_THEMES["其他"];
            const consolidated = useMemo(() => {
                const map = new Map();
                stack.instances.forEach(inst => {
                    const key = `${inst.date}-${inst.acquiredPrice}-${inst.isPreorder}-${inst.shippingDate}-${inst.currency}`;
                    if (!map.has(key)) map.set(key, { ...inst, count: 1 }); else map.get(key).count++;
                });
                return Array.from(map.values());
            }, [stack.instances]);

            return (
                <div 
                    draggable={isDraggable} 
                    onDragStart={(e) => handleDragStart(e, index, 'collection')} 
                    onDragEnter={(e) => handleDragEnter(e, index)} 
                    onDragEnd={handleDragEnd} 
                    onDragOver={(e) => { e.preventDefault(); handleDragEnter(e, index); }}
                    className={`bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col group relative ${isDraggable ? 'cursor-move' : ''}`}
                >
                    {isDraggable && (
                        <div className="absolute top-2 left-2 z-20 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 rounded-lg p-1 backdrop-blur-sm">
                            <button onClick={(e) => {e.stopPropagation(); handleMoveStack(index, -1)}} className="p-1 hover:bg-blue-100 rounded text-blue-600 disabled:opacity-30" disabled={index === 0}><Icon name="ArrowLeft" size={14} /></button>
                            <button onClick={(e) => {e.stopPropagation(); handleMoveStack(index, 1)}} className="p-1 hover:bg-blue-100 rounded text-blue-600 disabled:opacity-30"><Icon name="ArrowRight" size={14} /></button>
                        </div>
                    )}

                    {stack.totalCount > 1 && <div className="absolute top-2 left-2 z-10 bg-slate-900 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">x{stack.totalCount}</div>}
                    <div className={`h-40 w-full relative bg-gray-100 flex items-center justify-center overflow-hidden`}>
                        {stack.image ? <img src={stack.image} className="w-full h-full object-cover pointer-events-none" /> : <Icon name="Image" className={`opacity-20 ${theme.text}`} size={32} />}
                        <div className="absolute top-2 right-2"><span className={`text-[10px] font-bold px-2 py-1 rounded-full bg-white/90 shadow-sm ${theme.text}`}>{stack.character}</span></div>
                    </div>
                    <div className="p-3 flex-1 flex flex-col bg-white">
                        <h3 className="font-bold text-gray-800 text-sm line-clamp-1">{stack.name}</h3>
                        <div className="flex-1 mt-1 space-y-2 overflow-y-auto max-h-[120px] thin-scrollbar pr-1">
                            {consolidated.map((inst, idx) => (
                                <div key={idx} className="bg-gray-50 rounded p-2 text-xs border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <div className="flex gap-1 text-[10px] text-gray-500 items-center">
                                            {inst.isPreorder ? 
                                                <span className="text-orange-500 font-bold flex items-center gap-0.5"><Icon name="Package" size={10}/> 預購 {inst.shippingDate}</span> 
                                                : 
                                                <span className="flex items-center gap-0.5"><Icon name="Calendar" size={10}/> {inst.date}</span>
                                            }
                                        </div>
                                        <div className="flex items-baseline gap-1">
                                            <span className="font-bold text-base text-slate-800">
                                                {inst.currency === 'r' ? `${inst.acquiredPrice}r` : `NT$ ${inst.acquiredPrice}`}
                                            </span>
                                            {inst.officialPrice && <span className="text-[11px] text-gray-500 font-medium ml-1">({inst.officialPrice}{!isNaN(Number(inst.officialPrice)) && 'r'})</span>}
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center gap-1 ml-auto pl-2 border-l border-gray-100">
                                        {inst.count > 1 && <span className="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded-full mr-1">x{inst.count}</span>}
                                        <button onClick={(e)=>{e.stopPropagation(); openModal(inst, null, 'collection');}} className="p-1.5 bg-white border border-gray-200 rounded-md hover:text-blue-600 hover:border-blue-300 shadow-sm transition-all"><Icon name="Edit3" size={12}/></button>
                                        <button onClick={(e)=>{e.stopPropagation(); deleteFromCollection(inst.id);}} className="p-1.5 bg-white border border-gray-200 rounded-md hover:text-red-500 hover:border-red-300 shadow-sm transition-all"><Icon name="Trash2" size={12}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        });

        const CatalogCard = memo(({ item, index, isDraggable, handleDragStart, handleDragEnter, handleDragEnd, openModal, deleteFromCatalog }) => {
            const theme = CHARACTER_THEMES[item.character] || CHARACTER_THEMES["其他"];
            const priceDisplay = item.officialPrice ? (isNaN(Number(item.officialPrice)) ? item.officialPrice : `${item.officialPrice}r`) : '?';
            
            return (
                <div 
                    draggable={isDraggable} 
                    onDragStart={(e) => handleDragStart(e, index, 'catalog')} 
                    onDragEnter={(e) => handleDragEnter(e, index)} 
                    onDragEnd={handleDragEnd} 
                    onDragOver={(e) => { e.preventDefault(); handleDragEnter(e, index); }}
                    className={`bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group relative ${isDraggable ? 'cursor-move' : ''}`}
                >
                    <div className="aspect-square bg-gray-50 relative overflow-hidden">
                        <img src={item.image} alt={item.name} className="w-full h-full object-cover pointer-events-none" />
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                        <button onClick={() => openModal(null, item, 'collection')} className="absolute bottom-3 right-3 bg-white text-blue-600 p-2 rounded-full shadow-lg transform translate-y-10 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all z-20 w-10 h-10 flex items-center justify-center" title="加入我的收藏"><Icon name="Plus" size={24} /></button>
                        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                            <button onClick={() => openModal(item, null, 'catalog')} className="p-1.5 bg-white/90 rounded-full text-slate-600 hover:text-blue-600 shadow-sm"><Icon name="Edit3" size={14} /></button>
                            <button onClick={() => deleteFromCatalog(item.id)} className="p-1.5 bg-white/90 rounded-full text-slate-600 hover:text-red-600 shadow-sm"><Icon name="Trash2" size={14} /></button>
                        </div>
                    </div>
                    <div className="p-3 relative">
                        <div className="flex items-center gap-2 mb-1"><span className={`text-[10px] px-2 py-0.5 rounded-full ${theme.badge}`}>{item.character}</span><span className="text-[10px] text-gray-500 border px-1 rounded">{item.type}</span></div>
                        <h3 className="font-bold text-gray-800 text-sm truncate">{item.name}</h3>
                        <div className="flex justify-end mt-2">
                            <span className="text-xl font-bold text-black">{priceDisplay}</span>
                        </div>
                    </div>
                </div>
            );
        });

        const SettingsModal = memo(({ 
            isOpen, onClose, appSettings, setAppSettings, 
            importJson, setImportJson, handleBulkImport, handleExportCatalog, handleResetData,
            handleDragStart, handleDragEnter, handleDragEnd, handleAddType, handleDeleteType, newTypeInput, setNewTypeInput,
            handleCharDragStart
        }) => {
            const [settingsTab, setSettingsTab] = useState('layout');
            
            if (!isOpen) return null;

            const toggleCharacterVisibility = (char) => {
                setAppSettings(prev => {
                    const current = prev.visibleCharacters;
                    if (char === "ALL") {
                         const allMainSelected = CHARACTERS.every(c => current.includes(c));
                         return allMainSelected ? { ...prev, visibleCharacters: [] } : { ...prev, visibleCharacters: [...CHARACTERS] };
                    } else {
                        return current.includes(char) 
                            ? { ...prev, visibleCharacters: current.filter(c => c !== char) } 
                            : { ...prev, visibleCharacters: [...current, char] };
                    }
                });
            };

            const toggleMultiSelect = (key) => {
                setAppSettings(prev => ({ ...prev, multiSelect: { ...prev.multiSelect, [key]: !prev.multiSelect[key] } }));
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-3xl w-full max-w-lg p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center border-b pb-3">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Icon name="Settings" /> 設定</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><Icon name="X" size={20}/></button>
                        </div>
                        
                        <div className="flex gap-2 border-b pb-2 overflow-x-auto">
                            {['layout', 'filter', 'filters_config', 'types', 'data'].map(t => (
                                <button key={t} onClick={()=>setSettingsTab(t)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${settingsTab===t ? 'bg-slate-900 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>
                                    {t==='layout' ? '版面' : t==='filter' ? '角色管理' : t==='filters_config' ? '篩選設定' : t==='types' ? '類型' : '資料'}
                                </button>
                            ))}
                        </div>

                        {settingsTab === 'layout' && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">每行顯示數量</label>
                                    <div className="flex gap-2">
                                        {[2,3,4,5].map(cols => (
                                            <button key={cols} onClick={()=>setAppSettings(prev=>({...prev, layoutCols: cols}))} className={`flex-1 py-2 rounded-lg border text-sm font-bold ${appSettings.layoutCols===cols ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-200 text-gray-600 hover:bg-gray-50'}`}>{cols}</button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">預購預設幣值</label>
                                    <div className="flex gap-2">
                                        {['NT$', 'r'].map(curr => (
                                            <button key={curr} onClick={()=>setAppSettings(prev=>({...prev, defaultPreorderCurrency: curr}))} className={`flex-1 py-2 rounded-lg border text-sm font-bold ${appSettings.defaultPreorderCurrency===curr ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-200 text-gray-600 hover:bg-gray-50'}`}>{curr}</button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-gray-50">
                                        <input 
                                            type="checkbox" 
                                            className="w-5 h-5 text-blue-600 rounded"
                                            checked={appSettings.groupAllInFilterMode}
                                            onChange={(e) => setAppSettings(prev => ({...prev, groupAllInFilterMode: e.target.checked}))}
                                        />
                                        <span className="text-sm font-medium">顯示分類大標題 (全部模式)</span>
                                    </label>
                                    <p className="text-xs text-gray-400 mt-1 ml-1">在「全部」檢視下，是否依據當前模式顯示分組標題。</p>
                                </div>
                            </div>
                        )}

                        {settingsTab === 'filter' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <p className="text-sm text-gray-500">拖曳排序或勾選顯示角色。</p>
                                    <button onClick={() => toggleCharacterVisibility('ALL')} className="text-xs bg-slate-800 text-white px-3 py-1 rounded-full hover:bg-slate-700">我全都要</button>
                                </div>
                                <div className="space-y-2">
                                    {appSettings.customCharacters.map((char, index) => {
                                        const isChecked = appSettings.visibleCharacters.includes(char);
                                        return (
                                            <div 
                                                key={char} 
                                                className="flex items-center justify-between p-3 border rounded-xl bg-white hover:bg-gray-50 group cursor-grab active:cursor-grabbing"
                                                draggable
                                                onDragStart={(e) => handleCharDragStart(e, index)}
                                                onDragEnter={(e) => handleDragEnter(e, index)}
                                                onDragEnd={handleDragEnd}
                                                onDragOver={(e) => { e.preventDefault(); handleDragEnter(e, index); }}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <Icon name="GripVertical" size={16} className="text-gray-400" />
                                                    <span className={`text-sm font-medium ${CHARACTER_THEMES[char]?.text}`}>{char}</span>
                                                </div>
                                                <input type="checkbox" className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer" checked={isChecked} onChange={() => toggleCharacterVisibility(char)} />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {settingsTab === 'filters_config' && (
                            <div className="space-y-4">
                                <p className="text-sm text-gray-500">設定各篩選模式是否啟用多選功能。</p>
                                <div className="space-y-3">
                                    {['series', 'type', 'character', 'date'].map(key => (
                                        <label key={key} className="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-gray-50">
                                            <input type="checkbox" className="w-5 h-5 text-blue-600 rounded" checked={appSettings.multiSelect[key]} onChange={() => toggleMultiSelect(key)} />
                                            <span className="text-sm font-medium">依{key==='series'?'系列':key==='type'?'類型':key==='character'?'角色':'收物日'} - 多選</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                        )}

                        {settingsTab === 'types' && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">新增類型</label>
                                    <div className="flex gap-2">
                                        <input className="border p-2 rounded flex-1" placeholder="輸入新類型名稱..." value={newTypeInput} onKeyDown={(e) => e.key === 'Enter' && handleAddType()} onChange={e=>setNewTypeInput(e.target.value)} />
                                        <button onClick={handleAddType} className="bg-green-500 text-white px-4 rounded hover:bg-green-600">新增</button>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">目前類型列表 (拖曳排序)</label>
                                    <div className="flex flex-wrap gap-2">
                                        {appSettings.customTypes.map((t, index) => (
                                            <span 
                                                key={t} 
                                                className="px-3 py-1 bg-gray-100 rounded-full text-xs flex items-center gap-1 group cursor-grab active:cursor-grabbing"
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index, 'settings-type')}
                                                onDragEnter={(e) => handleDragEnter(e, index)}
                                                onDragEnd={handleDragEnd}
                                                onDragOver={(e) => { e.preventDefault(); handleDragEnter(e, index); }}
                                            >
                                                {t}
                                                <button onClick={()=>handleDeleteType(t)} className="text-gray-400 hover:text-red-500"><Icon name="X" size={12}/></button>
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {settingsTab === 'data' && (
                            <div className="space-y-4">
                                <div className="bg-blue-50 p-4 rounded-xl text-sm text-blue-800"><p className="font-bold mb-1">批次匯入：</p><p>貼上 Excel 或 JSON。匯入後將存入共用圖鑑。</p></div>
                                <textarea className="w-full h-32 p-3 border rounded-xl text-xs" value={importJson} onChange={e=>setImportJson(e.target.value)} placeholder="貼上內容..."></textarea>
                                <div className="flex gap-2">
                                    <button onClick={handleBulkImport} className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">匯入</button>
                                    <button onClick={handleExportCatalog} className="flex-1 border border-gray-300 text-gray-600 py-2 rounded hover:bg-gray-50">匯出</button>
                                </div>
                                <hr />
                                <button onClick={handleResetData} className="w-full text-red-500 border border-red-200 py-2 rounded hover:bg-red-50 text-sm">⚠️ 清空本地快取資料</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        });

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState(() => localStorage.getItem('deepspace_active_tab') || 'collection');

            const [appSettings, setAppSettings] = useState(() => {
                const savedSettings = localStorage.getItem('deepspace_settings');
                const defaults = {
                    layoutCols: 4, 
                    customTypes: DEFAULT_MERCH_TYPES,
                    customCharacters: CHARACTERS,
                    visibleCharacters: CHARACTERS,
                    multiSelect: { type: true, character: false, date: false, series: false },
                    defaultPreorderCurrency: 'NT$',
                    groupAllInFilterMode: true
                };
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    if (!parsed.visibleCharacters) parsed.visibleCharacters = CHARACTERS;
                    if (!parsed.customCharacters) parsed.customCharacters = CHARACTERS;
                    if (!parsed.multiSelect) parsed.multiSelect = defaults.multiSelect;
                    if (typeof parsed.multiSelect.series === 'undefined') parsed.multiSelect.series = false;
                    if (!parsed.defaultPreorderCurrency) parsed.defaultPreorderCurrency = 'NT$';
                    if (typeof parsed.groupAllInFilterMode === 'undefined') parsed.groupAllInFilterMode = true;
                    return parsed;
                }
                return defaults;
            });

            useEffect(() => { localStorage.setItem('deepspace_settings', JSON.stringify(appSettings)); }, [appSettings]);
            useEffect(() => { localStorage.setItem('deepspace_active_tab', activeTab); }, [activeTab]);

            const [groupingMode, setGroupingMode] = useState('none'); 
            const [collectionGroupingMode, setCollectionGroupingMode] = useState('none'); 
            const [selectedTypeFilters, setSelectedTypeFilters] = useState([]); 
            const [selectedCharFilters, setSelectedCharFilters] = useState([]); 
            const [selectedDateFilters, setSelectedDateFilters] = useState([]);
            const [selectedSeriesFilters, setSelectedSeriesFilters] = useState([]); 
            const [dateSortOrder, setDateSortOrder] = useState('desc'); 
            const [exchangeRate, setExchangeRate] = useState(4.5); 
            const [exchangeRateTimestamp, setExchangeRateTimestamp] = useState(null);
            const [showRmbDetail, setShowRmbDetail] = useState(false);
            
            const [items, setItems] = useState([]); 
            const [catalogItems, setCatalogItems] = useState([]); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false); 
            const [editingItem, setEditingItem] = useState(null); 
            const [modalMode, setModalMode] = useState('collection');
            const [formData, setFormData] = useState({});
            const [importJson, setImportJson] = useState('');
            const [newTypeInput, setNewTypeInput] = useState(''); 

            const dragItem = useRef(null);
            const dragOverItem = useRef(null);
            const dragType = useRef(null); 
            const fileInputRef = useRef(null);

            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/CNY')
                    .then(res => res.json())
                    .then(data => {
                        if(data && data.rates && data.rates.TWD) {
                            setExchangeRate(data.rates.TWD);
                            const now = new Date();
                            setExchangeRateTimestamp(`${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`);
                        }
                    })
                    .catch(err => console.error("Exchange rate error", err));
            }, []);

            useEffect(() => {
                setSelectedTypeFilters([]); setSelectedCharFilters([]); setSelectedDateFilters([]); setSelectedSeriesFilters([]);
            }, [collectionGroupingMode, groupingMode]);

            useEffect(() => {
                if (!isFirebaseInitialized) {
                    const localItems = localStorage.getItem('deepspace_items_v7_local');
                    if (localItems) setItems(JSON.parse(localItems));
                    const localCatalog = localStorage.getItem('deepspace_catalog_v7_local');
                    if (localCatalog) setCatalogItems(JSON.parse(localCatalog));
                    return;
                }
                
                setPersistence(auth, browserLocalPersistence).catch(console.error);

                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        if (!currentUser.isAnonymous) setUser(currentUser);
                        else setUser(null); 
                    } else {
                        setUser(null);
                        signInAnonymously(auth).catch(console.error);
                    }
                });
                
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isFirebaseInitialized) return;
                if (!auth.currentUser) return;

                const catalogColl = collection(db, 'artifacts', GLOBAL_APP_ID, 'public', 'data', 'catalog');
                const unsubCatalog = onSnapshot(catalogColl, (snapshot) => {
                    const cloudCatalog = snapshot.docs.map(doc => doc.data());
                    cloudCatalog.sort((a, b) => (a.order || 0) - (b.order || 0));
                    setCatalogItems(cloudCatalog);
                }, () => {});

                let unsubCollection = () => {};
                if (user) { 
                    const userColl = collection(db, 'artifacts', GLOBAL_APP_ID, 'users', user.uid, 'items');
                    unsubCollection = onSnapshot(userColl, (snapshot) => {
                        const cloudItems = snapshot.docs.map(doc => doc.data());
                        cloudItems.sort((a, b) => (a.order || 0) - (b.order || 0));
                        setItems(cloudItems);
                    }, console.error);
                } else { 
                    const localItems = localStorage.getItem('deepspace_items_v7_local');
                    if (localItems) setItems(JSON.parse(localItems));
                }
                return () => { unsubCatalog(); unsubCollection(); };
            }, [user, auth.currentUser]);

            useEffect(() => {
                if (!isFirebaseInitialized || !user) localStorage.setItem('deepspace_items_v7_local', JSON.stringify(items));
            }, [items, user]);
            useEffect(() => {
                if (!isFirebaseInitialized) localStorage.setItem('deepspace_catalog_v7_local', JSON.stringify(catalogItems));
            }, [catalogItems]);

            const handleLogin = async () => {
                if (window.location.protocol === 'file:') return alert("請使用 Live Server 或上傳至網頁空間開啟。");
                if (!isFirebaseInitialized) return alert("請設定 Firebase Config");
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { alert(e.message); }
            };
            const handleLogout = () => signOut(auth);

            const saveToCollection = async (newItem) => {
                const itemWithOrder = { ...newItem, order: newItem.order || Date.now() };
                if (user && isFirebaseInitialized) {
                    await setDoc(doc(db, `artifacts/${GLOBAL_APP_ID}/users/${user.uid}/items`, newItem.id), itemWithOrder);
                } else {
                    setItems(prev => {
                        const exists = prev.find(i => i.id === newItem.id);
                        return exists ? prev.map(i => i.id === newItem.id ? itemWithOrder : i) : [...prev, itemWithOrder];
                    });
                }
            };
            const deleteFromCollection = async (itemId) => {
                if (user && isFirebaseInitialized) {
                    await deleteDoc(doc(db, `artifacts/${GLOBAL_APP_ID}/users/${user.uid}/items`, itemId));
                } else { setItems(prev => prev.filter(i => i.id !== itemId)); }
            };
            const saveToCatalog = async (newItem) => {
                if (!isFirebaseInitialized) {
                    setCatalogItems(prev => {
                        const exists = prev.find(i => i.id === newItem.id);
                        return exists ? prev.map(i => i.id === newItem.id ? newItem : i) : [...prev, newItem];
                    }); return;
                }
                let order = newItem.order || Date.now();
                await setDoc(doc(db, `artifacts/${GLOBAL_APP_ID}/public/data/catalog`, newItem.id), { ...newItem, order }, { merge: true });
            };
            const deleteFromCatalog = async (itemId) => {
                if (confirm("警告：確定要從共用圖鑑刪除嗎？")) {
                    if (isFirebaseInitialized) await deleteDoc(doc(db, `artifacts/${GLOBAL_APP_ID}/public/data/catalog`, itemId));
                    else setCatalogItems(prev => prev.filter(i => i.id !== itemId));
                }
            };

            // --- Drag Handlers ---
            const handleDragStart = (e, index, type) => {
                if (type !== 'settings-type' && type !== 'settings-character') {
                     const currentMode = type === 'collection' ? collectionGroupingMode : (type === 'catalog' ? groupingMode : 'none');
                     if (currentMode !== 'none') { e.preventDefault(); return; }
                }
                
                dragItem.current = index;
                dragType.current = type;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData('type', type);
            };

            const handleDragEnter = (e, index) => dragOverItem.current = index;

            const handleDragEnd = async (e) => {
                e.target.classList.remove('dragging');
                const type = dragType.current;
                if (dragItem.current === null || dragOverItem.current === null || dragItem.current === dragOverItem.current) {
                    dragItem.current = null; dragOverItem.current = null; return;
                }

                if (type === 'settings-type') {
                    const newTypes = [...appSettings.customTypes];
                    const movedType = newTypes[dragItem.current];
                    newTypes.splice(dragItem.current, 1);
                    newTypes.splice(dragOverItem.current, 0, movedType);
                    setAppSettings(prev => ({ ...prev, customTypes: newTypes }));
                } else if (type === 'settings-character') {
                    const newChars = [...appSettings.customCharacters];
                    const movedChar = newChars[dragItem.current];
                    newChars.splice(dragItem.current, 1);
                    newChars.splice(dragOverItem.current, 0, movedChar);
                    setAppSettings(prev => ({ ...prev, customCharacters: newChars }));
                } else if (type === 'collection') {
                    const currentStacks = getStackedItems(items, 'none');
                    const moved = currentStacks[dragItem.current];
                    currentStacks.splice(dragItem.current, 1);
                    currentStacks.splice(dragOverItem.current, 0, moved);
                    const newFlatList = currentStacks.flatMap(s => s.instances);
                    setItems(newFlatList);
                    if (isFirebaseInitialized && user) {
                        const batch = writeBatch(db);
                        const path = `artifacts/${GLOBAL_APP_ID}/users/${user.uid}/items`;
                        newFlatList.forEach((item, index) => batch.update(doc(db, path, item.id), { order: index }));
                        try { await batch.commit(); } catch (err) { console.error(err); }
                    }
                } else if (type === 'catalog') {
                    if (!isFirebaseInitialized) {
                        const _items = [...catalogItems];
                        const moved = _items[dragItem.current];
                        _items.splice(dragItem.current, 1);
                        _items.splice(dragOverItem.current, 0, moved);
                        setCatalogItems(_items);
                    } else {
                         alert("提示：公開圖鑑排序僅本地暫時生效。");
                         const newOrderList = [...catalogItems];
                         const movedItem = newOrderList[dragItem.current];
                         newOrderList.splice(dragItem.current, 1);
                         newOrderList.splice(dragOverItem.current, 0, movedItem);
                         setCatalogItems(newOrderList);
                    }
                }
                dragItem.current = null; dragOverItem.current = null; dragType.current = null;
            };

            const handleMoveStack = async (index, direction) => {
                const currentStacks = getStackedItems(items, 'none');
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= currentStacks.length) return;
                const moved = currentStacks[index];
                currentStacks.splice(index, 1);
                currentStacks.splice(newIndex, 0, moved);
                const newFlatList = currentStacks.flatMap(s => s.instances);
                setItems(newFlatList);
                if (isFirebaseInitialized && user) {
                    const batch = writeBatch(db);
                    const path = `artifacts/${GLOBAL_APP_ID}/users/${user.uid}/items`;
                    newFlatList.forEach((item, idx) => batch.update(doc(db, path, item.id), { order: index }));
                    try { await batch.commit(); } catch (err) { console.error(err); }
                }
            };

            const handleAddType = () => {
                if (newTypeInput && !appSettings.customTypes.includes(newTypeInput)) {
                    setAppSettings(prev => ({...prev, customTypes: [...prev.customTypes, newTypeInput]}));
                    setNewTypeInput('');
                }
            };
            const handleDeleteType = (t) => {
                if (confirm(`確定要刪除類型「${t}」嗎？`)) {
                    setAppSettings(prev => ({...prev, customTypes: prev.customTypes.filter(type => type !== t)}));
                }
            };
            
            const toggleCharacterVisibility = (char) => {
                setAppSettings(prev => {
                    const current = prev.visibleCharacters;
                    if (char === "ALL") {
                         const allMainSelected = CHARACTERS.every(c => current.includes(c));
                         if (allMainSelected) {
                             return { ...prev, visibleCharacters: [] }; 
                         } else {
                             return { ...prev, visibleCharacters: [...CHARACTERS] }; 
                         }
                    } else {
                        if (current.includes(char)) {
                            return { ...prev, visibleCharacters: current.filter(c => c !== char) };
                        } else {
                            return { ...prev, visibleCharacters: [...current, char] };
                        }
                    }
                });
            };

            const toggleMultiSelect = (key) => {
                setAppSettings(prev => ({
                    ...prev,
                    multiSelect: {
                        ...prev.multiSelect,
                        [key]: !prev.multiSelect[key]
                    }
                }));
            };

            const openModal = (item = null, template = null, mode = 'collection') => {
                setModalMode(mode);
                const defaultData = { 
                    id: Date.now().toString(), 
                    name: '', 
                    character: '沈星回', 
                    type: '徽章', 
                    series: '', 
                    officialPrice: '', 
                    acquiredPrice: '', 
                    date: new Date().toISOString().split('T')[0], 
                    image: null, 
                    note: '', 
                    quantity: 1,
                    isPreorder: false, 
                    shippingDate: '',
                    currency: appSettings.defaultPreorderCurrency 
                };
                
                if (mode === 'catalog' && item) { 
                    setEditingItem(item); 
                    setFormData({ ...item }); 
                }
                else if (mode === 'collection') {
                    if (item) { 
                        setEditingItem(item); 
                        setFormData({ 
                            ...item, 
                            quantity: 1,
                            isPreorder: item.isPreorder || false,
                            shippingDate: item.shippingDate || '',
                            currency: item.currency || 'NT$' 
                        }); 
                    }
                    else if (template) { 
                        setEditingItem(null); 
                        setFormData({ 
                            ...defaultData, 
                            ...template, 
                            quantity: 1, 
                            id: Date.now().toString(),
                            isPreorder: false,
                            shippingDate: '',
                            currency: appSettings.defaultPreorderCurrency
                        }); 
                    }
                    else { 
                        setEditingItem(null); 
                        setFormData(defaultData); 
                    }
                }
                setIsModalOpen(true);
            };

            const handleSave = async () => {
                if (!formData.name) return alert("請輸入名稱");
                const timestamp = Date.now();
                if (formData.type && !appSettings.customTypes.includes(formData.type)) {
                    setAppSettings(prev => ({...prev, customTypes: [...prev.customTypes, formData.type]}));
                }

                if (modalMode === 'catalog') {
                    const itemToSave = { ...formData };
                    delete itemToSave.quantity; 
                    delete itemToSave.acquiredPrice; 
                    delete itemToSave.date; 
                    delete itemToSave.note;
                    delete itemToSave.isPreorder;
                    delete itemToSave.shippingDate;
                    delete itemToSave.currency;
                    await saveToCatalog(itemToSave);
                } else {
                    const qty = Math.max(1, parseInt(formData.quantity) || 1);
                    if (editingItem) {
                        const itemToSave = { ...formData };
                        delete itemToSave.quantity;
                        await saveToCollection(itemToSave);
                    } else {
                        for (let i = 0; i < qty; i++) {
                            const newItem = { ...formData, id: timestamp + '-' + i, order: timestamp + i };
                            delete newItem.quantity;
                            await saveToCollection(newItem);
                        }
                    }
                }
                setIsModalOpen(false);
            };
            
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSave();
                }
            };

            // --- Helpers ---
            const getEffectiveDate = (item) => item.isPreorder ? item.shippingDate : item.date;

            const getStackedItems = (sourceItems, mode) => {
                const map = new Map();
                const stacks = [];
                sourceItems.forEach(item => {
                    const key = item.name;
                    if (!map.has(key)) {
                        const stack = { ...item, instances: [item], totalCount: 1 };
                        map.set(key, stack);
                        stacks.push(stack);
                    } else {
                        const stack = map.get(key);
                        stack.instances.push(item);
                        stack.totalCount += 1;
                    }
                });
                return stacks;
            };

            const toggleFilter = (filterState, setFilterState, value, multiSelectEnabled) => {
                if (value === 'all') {
                    setFilterState([]);
                    return;
                }
                
                if (multiSelectEnabled) {
                    if (filterState.includes(value)) {
                        setFilterState(prev => prev.filter(v => v !== value));
                    } else {
                        setFilterState(prev => [...prev, value]);
                    }
                } else {
                     if (filterState.includes(value)) {
                         setFilterState([]); 
                     } else {
                         setFilterState([value]);
                     }
                }
            };

            const getFilteredList = (list, mode, typeFilters, charFilters, dateFilters, seriesFilters) => {
                let processed = list.filter(i => appSettings.visibleCharacters.includes(i.character));

                if (mode === 'type' && typeFilters.length > 0) {
                    processed = processed.filter(i => typeFilters.includes(i.type));
                }
                if (mode === 'character' && charFilters.length > 0) {
                    processed = processed.filter(i => charFilters.includes(i.character));
                }
                if (mode === 'date' && dateFilters.length > 0) {
                    processed = processed.filter(i => {
                        const effDate = getEffectiveDate(i);
                        return dateFilters.includes(effDate);
                    });
                }
                if (mode === 'series' && seriesFilters.length > 0) {
                    processed = processed.filter(i => seriesFilters.includes(i.series));
                }

                return processed;
            };

            const stats = useMemo(() => {
                const visibleItems = items.filter(i => appSettings.visibleCharacters.includes(i.character));
                const totalCount = visibleItems.length;
                let totalNT = 0, totalR = 0;
                visibleItems.forEach(item => {
                    const price = Number(item.acquiredPrice || 0);
                    if (item.currency === 'r') totalR += price; else totalNT += price;
                });
                const grandTotal = totalNT + (totalR * exchangeRate);
                const byChar = visibleItems.reduce((acc, item) => { acc[item.character] = (acc[item.character] || 0) + 1; return acc; }, {});
                return { totalCount, totalNT, totalR, grandTotal, byChar };
            }, [items, appSettings.visibleCharacters, exchangeRate]);

            const availableTypes = useMemo(() => {
                const types = new Set(items.map(i => i.type).filter(Boolean));
                return appSettings.customTypes.filter(t => types.has(t)).concat(Array.from(types).filter(t => !appSettings.customTypes.includes(t)));
            }, [items, appSettings.customTypes]);

            const availableDates = useMemo(() => {
                const dates = new Set(items.map(i => getEffectiveDate(i)).filter(Boolean));
                return Array.from(dates).sort((a, b) => new Date(b) - new Date(a));
            }, [items]);

            const preorderDates = useMemo(() => {
                const set = new Set();
                items.forEach(i => { if (i.isPreorder && i.shippingDate) set.add(i.shippingDate); });
                return set;
            }, [items]);

            const availableSeries = useMemo(() => {
                const source = activeTab === 'collection' ? items : catalogItems;
                const series = new Set(source.map(i => i.series).filter(Boolean));
                return Array.from(series).sort();
            }, [items, catalogItems, activeTab]);

            const getGroupedData = (list, mode, sortOrder, typeFilters, charFilters, dateFilters, seriesFilters) => {
                const processedList = getFilteredList(list, mode, typeFilters, charFilters, dateFilters, seriesFilters);

                const isAllSelected = (mode === 'type' && typeFilters.length === 0) || 
                                      (mode === 'character' && charFilters.length === 0) || 
                                      (mode === 'series' && seriesFilters.length === 0) || 
                                      (mode === 'date' && dateFilters.length === 0);

                if (mode === 'none' || (isAllSelected && !appSettings.groupAllInFilterMode)) {
                    return { '全部': processedList };
                }
                
                const grouped = processedList.reduce((acc, item) => {
                    let key = '';
                    if (mode === 'series') key = item.series || '其他系列';
                    else if (mode === 'type') key = item.type || '其他類型';
                    else if (mode === 'character') key = item.character || '其他角色';
                    else if (mode === 'date') key = getEffectiveDate(item) || '未知日期';
                    
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(item);
                    return acc;
                }, {});

                if (mode === 'date') {
                    const keys = Object.keys(grouped).sort((a,b) => {
                        if(a==='未知日期') return 1; if(b==='未知日期') return -1;
                        return sortOrder==='desc' ? new Date(b)-new Date(a) : new Date(a)-new Date(b);
                    });
                    const sorted = {}; keys.forEach(k=>sorted[k]=grouped[k]); return sorted;
                }
                
                // Custom sort order for Character grouping
                if (mode === 'character') {
                    const sorted = {};
                    appSettings.customCharacters.forEach(char => { if (grouped[char]) sorted[char] = grouped[char]; });
                    Object.keys(grouped).forEach(k => { if (!sorted[k]) sorted[k] = grouped[k]; });
                    return sorted;
                }
                
                return grouped;
            };

            const groupedData = useMemo(() => ({
                collection: getGroupedData(items, collectionGroupingMode, dateSortOrder, selectedTypeFilters, selectedCharFilters, selectedDateFilters, selectedSeriesFilters),
                catalog: getGroupedData(catalogItems, groupingMode, 'desc', selectedTypeFilters, selectedCharFilters, [], selectedSeriesFilters)
            }), [items, catalogItems, groupingMode, collectionGroupingMode, dateSortOrder, selectedTypeFilters, selectedCharFilters, selectedDateFilters, selectedSeriesFilters, appSettings.visibleCharacters, appSettings.groupAllInFilterMode, appSettings.customCharacters]);

            const gridStyle = { display: 'grid', gridTemplateColumns: `repeat(${appSettings.layoutCols}, minmax(0, 1fr))`, gap: '1rem' };

            return (
                <div className="min-h-screen bg-gray-50 pb-24 md:pb-0 md:pl-64">
                    <aside className="hidden md:flex fixed left-0 top-0 h-full w-64 bg-slate-900 text-white flex-col shadow-2xl z-30">
                        <div className="p-6 border-b border-slate-800"><h1 className="text-2xl font-bold tracking-wider flex items-center gap-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400"><Icon name="Star" className="text-yellow-400" size={24} /> 深空收藏艙</h1></div>
                        <div className="px-4 py-4 flex flex-col gap-2">
                            {user && !user.isAnonymous ? <div className="bg-slate-800 rounded-xl p-3 flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">{user.photoURL?<img src={user.photoURL} className="w-full h-full rounded-full"/>:user.email[0].toUpperCase()}</div><div className="flex-1 min-w-0"><p className="text-sm font-bold truncate">{user.displayName||'獵人'}</p><p className="text-xs text-slate-400">已連線</p></div><button onClick={handleLogout}><Icon name="LogOut" size={16}/></button></div> : <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl flex items-center justify-center gap-2"><Icon name="LogIn" size={18}/> Google 登入</button>}
                        </div>
                        <nav className="flex-1 px-4 space-y-2">
                            {['collection','templates','stats'].map(t => <button key={t} onClick={()=>setActiveTab(t)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab===t?'bg-blue-600 text-white':'hover:bg-slate-800 text-slate-300'}`}><Icon name={t==='collection'?'Package':t==='templates'?'ShoppingBag':'User'} size={20}/>{t==='collection'?'我的收藏庫':t==='templates'?'週邊圖鑑':'獵人檔案'}</button>)}
                        </nav>
                        <div className="px-4 pb-2"><button onClick={()=>setIsSettingsOpen(true)} className="w-full border border-slate-700 text-slate-400 text-xs py-1.5 rounded-lg flex items-center justify-center gap-1 hover:bg-slate-800 hover:text-slate-200"><Icon name="Settings" size={14}/> 設定</button></div>
                        <div className="p-4 bg-slate-800">
                            <div className="flex flex-col gap-1">
                                <p className="text-xs text-slate-400">總估算價值 (NT$)</p>
                                <p className="text-xl font-bold text-green-400">{Math.round(stats.grandTotal).toLocaleString()}</p>
                            </div>
                        </div>
                    </aside>

                    <div className="md:hidden bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg flex justify-between items-center">
                        <div className="flex items-center gap-2"><Icon name="Star" className="text-yellow-400" size={20}/><span className="font-bold">深空收藏艙</span></div>
                        <div className="flex gap-2 items-center">
                            <button onClick={()=>setIsSettingsOpen(true)}><Icon name="Settings" size={20}/></button>
                            {user && !user.isAnonymous ? <img src={user.photoURL} onClick={handleLogout} className="w-8 h-8 rounded-full border-2 border-blue-500"/> : <button onClick={handleLogin}><Icon name="LogIn"/></button>}
                        </div>
                    </div>

                    <main className="p-4 md:p-8 max-w-6xl mx-auto">
                        {activeTab === 'collection' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div className="flex-1 flex items-center gap-4">
                                        <h2 className="text-2xl font-bold text-gray-800">我的收藏庫 <span className="text-xs font-normal text-gray-400 ml-2">{user && !user.isAnonymous ? '(雲端私有)' : '(本機暫存)'}</span></h2>
                                        <button onClick={()=>openModal(null, null, 'collection')} className="bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm shadow-md"><Icon name="Plus" size={16}/> 新增</button>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto scrollbar-hide">
                                        {collectionGroupingMode==='date' && <button onClick={()=>setDateSortOrder(p=>p==='desc'?'asc':'desc')} className="px-3 py-1.5 text-xs border rounded-lg bg-white text-blue-600 flex gap-1"><Icon name={dateSortOrder==='desc'?'ArrowDownNarrowWide':'ArrowUpNarrowWide'} size={14}/> {dateSortOrder==='desc'?'從新到舊':'從舊到新'}</button>}
                                        {[{id:'none',l:'全部'},{id:'series',l:'依系列'},{id:'type',l:'依類型'},{id:'character',l:'依角色'},{id:'date',l:'依收物日'}].map(m=><button key={m.id} onClick={()=>setCollectionGroupingMode(m.id)} className={`px-3 py-1.5 text-xs border rounded-lg whitespace-nowrap ${collectionGroupingMode===m.id?'bg-slate-900 text-white':'bg-white text-gray-500'}`}>{m.l}</button>)}
                                    </div>
                                </div>
                                
                                {collectionGroupingMode === 'series' && <FilterBar options={availableSeries} selected={selectedSeriesFilters} toggle={(val)=>toggleFilter(selectedSeriesFilters, setSelectedSeriesFilters, val, appSettings.multiSelect.series)} multi={appSettings.multiSelect.series} />}
                                {collectionGroupingMode === 'type' && <FilterBar options={availableTypes} selected={selectedTypeFilters} toggle={(val)=>toggleFilter(selectedTypeFilters, setSelectedTypeFilters, val, appSettings.multiSelect.type)} multi={appSettings.multiSelect.type} />}
                                {collectionGroupingMode === 'character' && <FilterBar options={appSettings.customCharacters} selected={selectedCharFilters} toggle={(val)=>toggleFilter(selectedCharFilters, setSelectedCharFilters, val, appSettings.multiSelect.character)} multi={appSettings.multiSelect.character} />}
                                {collectionGroupingMode === 'date' && <FilterBar options={availableDates} selected={selectedDateFilters} toggle={(val)=>toggleFilter(selectedDateFilters, setSelectedDateFilters, val, appSettings.multiSelect.date)} multi={appSettings.multiSelect.date} highlightSet={preorderDates} />}

                                <div className="space-y-8">
                                    {Object.entries(groupedData.collection).map(([gName, gItems]) => {
                                        const stacks = getStackedItems(gItems, collectionGroupingMode);
                                        return <div key={gName} className="animate-in fade-in">
                                            {/* Group Headers logic - Only show if grouping is ACTIVE */}
                                            {collectionGroupingMode !== 'none' && (
                                                <div className="flex items-center gap-2 mb-4 mt-6 first:mt-0">
                                                    <div className={`h-6 w-1 rounded-full ${preorderDates.has(gName) ? 'bg-yellow-400' : 'bg-blue-500'}`}></div>
                                                    <h3 className="font-bold text-lg text-gray-700">{gName} <span className="text-xs text-gray-400 font-normal ml-1">({stacks.length})</span></h3>
                                                </div>
                                            )}

                                            <div style={gridStyle}>{stacks.map((s,i)=><StackCard key={s.id} stack={s} index={i} isDraggable={collectionGroupingMode==='none'} handleDragStart={handleDragStart} handleDragEnter={handleDragEnter} handleDragEnd={handleDragEnd} handleMoveStack={handleMoveStack} openModal={openModal} deleteFromCollection={deleteFromCollection} />)}</div>
                                        </div>;
                                    })}
                                    {items.length===0 && <div className="text-center py-20 text-gray-400 border-2 border-dashed rounded-3xl">尚無收藏</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'templates' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div><h2 className="text-2xl font-bold text-gray-800">共用週邊圖鑑</h2><p className="text-xs text-gray-400">資料共用，歡迎匯入分享</p></div>
                                    <div className="flex gap-2 items-center">
                                        {[{id:'none',l:'全部'},{id:'series',l:'依系列'},{id:'type',l:'依類型'},{id:'character',l:'依角色'}].map(m=><button key={m.id} onClick={()=>setGroupingMode(m.id)} className={`px-3 py-1.5 text-xs border rounded-lg ${groupingMode===m.id?'bg-slate-900 text-white':'bg-white text-gray-500'}`}>{m.l}</button>)}
                                    </div>
                                </div>
                                {groupingMode === 'series' && <FilterBar options={availableSeries} selected={selectedSeriesFilters} toggle={(val)=>toggleFilter(selectedSeriesFilters, setSelectedSeriesFilters, val, appSettings.multiSelect.series)} multi={appSettings.multiSelect.series} />}
                                {groupingMode === 'type' && <FilterBar options={availableTypes} selected={selectedTypeFilters} toggle={(val)=>toggleFilter(selectedTypeFilters, setSelectedTypeFilters, val, appSettings.multiSelect.type)} multi={appSettings.multiSelect.type} />}
                                {groupingMode === 'character' && <FilterBar options={appSettings.customCharacters} selected={selectedCharFilters} toggle={(val)=>toggleFilter(selectedCharFilters, setSelectedCharFilters, val, appSettings.multiSelect.character)} multi={appSettings.multiSelect.character} />}
                                <div className="space-y-8">
                                    {Object.entries(groupedData.catalog).map(([gName, gItems]) => (
                                        <div key={gName} className="animate-in fade-in">
                                            {/* Header for None mode if grouping enabled */}
                                            {groupingMode !== 'none' && (
                                                <div className="flex items-center gap-2 mb-4 mt-6 first:mt-0">
                                                    <div className="h-6 w-1 bg-blue-500 rounded-full"></div>
                                                    <h3 className="font-bold text-lg text-gray-700">{gName} <span className="text-xs text-gray-400 font-normal ml-1">({gItems.length})</span></h3>
                                                </div>
                                            )}
                                            <div style={gridStyle}>{gItems.map((item,i)=><CatalogCard key={item.id} item={item} index={i} isDraggable={groupingMode==='none'} handleDragStart={handleDragStart} handleDragEnter={handleDragEnter} handleDragEnd={handleDragEnd} openModal={openModal} deleteFromCatalog={deleteFromCatalog}/>)}</div>
                                        </div>
                                    ))}
                                    {catalogItems.length===0 && <div className="text-center py-20 text-gray-400">圖鑑目前是空的</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6 animate-fade-in">
                                <h2 className="text-2xl font-bold text-gray-800">消費報告</h2>
                                <p className="text-sm text-gray-500 mb-4 font-medium">
                                   目前匯率: 1r ≈ {exchangeRate} NT$ {exchangeRateTimestamp && <span className="text-gray-400 text-xs ml-1">(更新於: {exchangeRateTimestamp})</span>}
                                </p>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-slate-900 rounded-2xl p-6 text-white">
                                        <p className="text-slate-400 text-sm">總估算價值 (NT$)</p>
                                        <p className="text-3xl font-bold">{Math.round(stats.grandTotal).toLocaleString()}</p>
                                    </div>
                                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 grid grid-cols-2 gap-4">
                                         <div>
                                            <p className="text-xs text-gray-500">台幣支出 (NT$)</p>
                                            <p className="text-xl font-bold text-slate-800">{stats.totalNT.toLocaleString()}</p>
                                         </div>
                                         <div className="relative">
                                            <div className="flex justify-between items-start">
                                                <p className="text-xs text-gray-500">人民幣支出 (r)</p>
                                                <button 
                                                    onClick={() => setShowRmbDetail(!showRmbDetail)}
                                                    className="text-[10px] text-blue-500 hover:underline bg-blue-50 px-2 py-0.5 rounded"
                                                >
                                                    {showRmbDetail ? "還原" : "換算"}
                                                </button>
                                            </div>
                                            {showRmbDetail ? (
                                                <div className="animate-fade-in mt-1">
                                                    <p className="text-sm font-bold text-slate-800">
                                                        {stats.totalR.toLocaleString()} <span className="text-xs font-normal text-gray-400">r</span>
                                                    </p>
                                                    <p className="text-xs text-gray-400 my-0.5">×</p>
                                                    <p className="text-sm font-bold text-slate-800">
                                                        {exchangeRate} <span className="text-xs font-normal text-gray-400">匯率</span>
                                                    </p>
                                                    <div className="border-t border-gray-200 my-1"></div>
                                                    <p className="text-sm font-bold text-green-600">
                                                        = NT$ {Math.round(stats.totalR * exchangeRate).toLocaleString()}
                                                    </p>
                                                </div>
                                            ) : (
                                                <p className="text-xl font-bold text-slate-800">{stats.totalR.toLocaleString()}</p>
                                            )}
                                         </div>
                                    </div>
                                    <div className="bg-white rounded-2xl p-6 shadow-sm col-span-3 space-y-2">
                                        <h3 className="font-bold text-gray-700 mb-4">收藏分布</h3>
                                        {Object.entries(stats.byChar).map(([c, count])=><div key={c} className="flex justify-between border-b pb-2"><span>{c}</span><span>{count}</span></div>)}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {isSettingsOpen && <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={()=>setIsSettingsOpen(false)}
                        appSettings={appSettings}
                        setAppSettings={setAppSettings}
                        importJson={importJson}
                        setImportJson={setImportJson}
                        handleBulkImport={handleBulkImport}
                        handleExportCatalog={handleExportCatalog}
                        handleResetData={handleResetData}
                        handleDragStart={handleDragStart}
                        handleDragEnter={handleDragEnter}
                        handleDragEnd={handleDragEnd}
                        handleAddType={handleAddType}
                        handleDeleteType={handleDeleteType}
                        newTypeInput={newTypeInput}
                        setNewTypeInput={setNewTypeInput}
                        handleCharDragStart={(e, idx) => handleDragStart(e, idx, 'settings-character')}
                    />}

                    {isModalOpen && (/* Modal Content reused from previous step, logic integrated */
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-w-lg p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center">
                                    <h3 className="font-bold">{modalMode === 'catalog' ? (editingItem ? '編輯公開圖鑑' : '新增公開圖鑑') : (editingItem ? '編輯我的收藏' : '加入我的收藏')}</h3>
                                    <button onClick={()=>setIsModalOpen(false)} className="p-1 rounded-full hover:bg-gray-100"><Icon name="X" size={20}/></button>
                                </div>
                                <div onClick={()=>fileInputRef.current.click()} className="w-32 h-32 mx-auto border-2 border-dashed rounded flex items-center justify-center cursor-pointer">{formData.image?<img src={formData.image} className="w-full h-full object-cover"/>:<Icon name="Upload"/>}<input type="file" ref={fileInputRef} className="hidden" onChange={(e)=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=()=>setFormData(p=>({...p,image:r.result}));r.readAsDataURL(f);}}}/></div>
                                <input className="w-full border p-2 rounded" placeholder="名稱" value={formData.name} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,name:e.target.value})}/>
                                <div className="grid grid-cols-2 gap-2">
                                    <select className="border p-2 rounded" value={formData.character} onChange={e=>setFormData({...formData,character:e.target.value})}>{CHARACTERS.map(c=><option key={c}>{c}</option>)}</select>
                                    <input className="border p-2 rounded" placeholder="系列" value={formData.series} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,series:e.target.value})}/>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="border p-2 rounded" list="types-list" placeholder="類型" value={formData.type} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,type:e.target.value})}/>
                                    <datalist id="types-list">{appSettings.customTypes.map(t=><option key={t} value={t}/>)}</datalist>
                                    <input type="text" className="border p-2 rounded" placeholder="原價" value={formData.officialPrice} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,officialPrice:e.target.value})}/>
                                </div>
                                {modalMode === 'collection' && (
                                    <>
                                        <hr className="border-gray-100" />
                                        <div className="flex items-center gap-2 mb-2">
                                            <input type="checkbox" id="isPreorder" checked={formData.isPreorder || false} onChange={e=>setFormData({...formData, isPreorder: e.target.checked})} className="w-4 h-4 text-blue-600 rounded"/>
                                            <label htmlFor="isPreorder" className="text-sm font-bold text-gray-700">預購商品</label>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="relative">
                                                <input type="number" className="border p-2 rounded w-full pr-12" placeholder="入手價格" value={formData.acquiredPrice} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,acquiredPrice:e.target.value})}/>
                                                {formData.isPreorder && <select className="absolute right-1 top-1 bottom-1 bg-gray-100 border-none text-xs rounded focus:ring-0" value={formData.currency || appSettings.defaultPreorderCurrency} onChange={e=>setFormData({...formData, currency: e.target.value})}><option value="NT$">NT$</option><option value="r">r</option></select>}
                                                {!formData.isPreorder && <span className="absolute right-3 top-2 text-gray-500 text-sm">NT$</span>}
                                            </div>
                                            {formData.isPreorder ? (
                                                <div className="relative"><span className="absolute -top-2 left-2 bg-white px-1 text-[10px] text-orange-500">預計出貨</span><input type="date" className="border p-2 rounded w-full border-orange-300" value={formData.shippingDate} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,shippingDate:e.target.value})}/></div>
                                            ) : (
                                                <div className="relative"><span className="absolute -top-2 left-2 bg-white px-1 text-[10px] text-gray-500">收物日期</span><input type="date" className="border p-2 rounded w-full" value={formData.date} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,date:e.target.value})}/></div>
                                            )}
                                        </div>
                                        {!editingItem && <div className="flex items-center gap-2"><label>數量:</label><input type="number" className="border p-1 w-16" value={formData.quantity} onKeyDown={handleKeyDown} onChange={e=>setFormData({...formData,quantity:e.target.value})}/></div>}
                                        <textarea className="w-full border p-2 rounded h-20" placeholder="備註..." value={formData.note} onChange={e=>setFormData({...formData,note:e.target.value})}/>
                                    </>
                                )}
                                <button onClick={handleSave} className="w-full bg-slate-900 text-white py-3 rounded">{modalMode === 'catalog' ? '更新圖鑑 (公開)' : '儲存收藏'}</button>
                            </div>
                        </div>
                    )}

                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t p-2 flex justify-around z-40">
                        <button onClick={()=>setActiveTab('collection')}><Icon name="Package"/><span className="text-xs">收藏</span></button>
                        <button onClick={()=>setActiveTab('templates')}><Icon name="ShoppingBag"/><span className="text-xs">圖鑑</span></button>
                        <button onClick={()=>setActiveTab('stats')}><Icon name="User"/><span className="text-xs">檔案</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
