<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深空收藏艙 | 獵人週邊管理 (雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .dragging { opacity: 0.5; transform: scale(0.95); box-shadow: 0 0 0 2px #3b82f6; z-index: 50; }
        .cursor-move { cursor: grab; }
        .cursor-move:active { cursor: grabbing; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .thin-scrollbar::-webkit-scrollbar { width: 4px; }
        .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .thin-scrollbar::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 20px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // --- 請在此處填入您的 Firebase 設定 ---
        // ==========================================
        const firebaseConfig = {
  		apiKey: "AIzaSyDxpH_rteE6PJq_bMmg3X2CxTs1lrQmhZA",
  		authDomain: "deepspace-collection.firebaseapp.com",
  		projectId: "deepspace-collection",
  		storageBucket: "deepspace-collection.firebasestorage.app",
  		messagingSenderId: "129454784064",
  		appId: "1:129454784064:web:38e7f8ffcf99d9a61ea9a5",
  		measurementId: "G-GCCS7NBT15"
	};


        // --- 初始化 Firebase ---
        let auth, db;
        let isFirebaseInitialized = false;

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseInitialized = true;
                console.log("Firebase initialized successfully.");
            } catch (e) { console.error("Firebase init error:", e); }
        } else if (typeof __firebase_config !== 'undefined') {
            try {
                const app = initializeApp(JSON.parse(__firebase_config));
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseInitialized = true;
            } catch(e) { console.log("Preview env init failed", e); }
        }

        // --- Icon 元件 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                const container = containerRef.current;
                if (!container || !window.lucide) return;
                container.innerHTML = '';
                const iconNode = window.lucide.icons[name];
                if (iconNode) {
                    const svgElement = window.lucide.createElement(iconNode);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    if (className) svgElement.setAttribute('class', className);
                    svgElement.setAttribute('stroke-width', 2);
                    container.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };

        // --- 預設資料 (已設定為空，請使用資料管理匯入) ---
        const DEFAULT_PRESET_CATALOG = [];

        const CHARACTERS = ["沈星回", "黎深", "祁煜", "秦徹", "夏以晝", "其他"];
        const CHARACTER_THEMES = {
            "沈星回": { bg: "bg-yellow-50", text: "text-yellow-700", border: "border-yellow-200", badge: "bg-yellow-100 text-yellow-800" },
            "黎深": { bg: "bg-slate-50", text: "text-slate-700", border: "border-slate-200", badge: "bg-slate-100 text-slate-800" },
            "祁煜": { bg: "bg-purple-50", text: "text-purple-700", border: "border-purple-200", badge: "bg-purple-100 text-purple-800" },
            "秦徹": { bg: "bg-red-50", text: "text-red-700", border: "border-red-200", badge: "bg-red-100 text-red-800" },
            "夏以晝": { bg: "bg-orange-50", text: "text-orange-700", border: "border-orange-200", badge: "bg-orange-100 text-orange-800" },
            "其他": { bg: "bg-gray-50", text: "text-gray-700", border: "border-gray-200", badge: "bg-gray-100 text-gray-800" }
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('collection'); 
            const [groupingMode, setGroupingMode] = useState('none'); 
            const [collectionGroupingMode, setCollectionGroupingMode] = useState('none'); 
            const [dateSortOrder, setDateSortOrder] = useState('desc'); 
            
            // 資料狀態
            const [items, setItems] = useState([]);
            const [catalogItems, setCatalogItems] = useState(DEFAULT_PRESET_CATALOG);
            
            // UI 狀態
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isDataModalOpen, setIsDataModalOpen] = useState(false); // 資料匯入匯出 Modal
            const [editingItem, setEditingItem] = useState(null); 
            const [formData, setFormData] = useState({});
            const [importJson, setImportJson] = useState(''); // 匯入內容
            
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);
            const fileInputRef = useRef(null);

            // --- Firebase Auth 監聽 ---
            useEffect(() => {
                if (!isFirebaseInitialized) {
                    const localItems = localStorage.getItem('deepspace_items_v6_html');
                    if (localItems) setItems(JSON.parse(localItems));
                    const localCatalog = localStorage.getItem('deepspace_catalog_v1_html');
                    if (localCatalog) setCatalogItems(JSON.parse(localCatalog));
                    return;
                }
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) {
                        const localItems = localStorage.getItem('deepspace_items_v6_html');
                        if (localItems) setItems(JSON.parse(localItems));
                        const localCatalog = localStorage.getItem('deepspace_catalog_v1_html');
                        if (localCatalog) setCatalogItems(JSON.parse(localCatalog));
                    }
                });
                return () => unsubscribe();
            }, []);

            // --- 資料同步 ---
            useEffect(() => {
                if (user && isFirebaseInitialized) {
                    let collRef;
                    if (typeof __app_id !== 'undefined') {
                         collRef = collection(db, 'artifacts', __app_id, 'users', user.uid, 'items');
                    } else {
                         collRef = collection(db, 'users', user.uid, 'items');
                    }
                    const unsub = onSnapshot(collRef, (snapshot) => {
                        const cloudItems = snapshot.docs.map(doc => doc.data());
                        setItems(cloudItems);
                    }, (error) => console.error("Firestore sync error:", error));
                    return () => unsub();
                } else {
                    if (!user) localStorage.setItem('deepspace_items_v6_html', JSON.stringify(items));
                }
            }, [user, items]);

            // --- 圖鑑資料儲存 (僅 LocalStorage) ---
            useEffect(() => {
                localStorage.setItem('deepspace_catalog_v1_html', JSON.stringify(catalogItems));
            }, [catalogItems]);

            // --- 登入/登出 ---
            const handleLogin = async () => {
                if (!isFirebaseInitialized) return alert("請先在程式碼中設定 Firebase Config！");
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } 
                catch (error) { console.error(error); alert("登入失敗"); }
            };
            const handleLogout = () => signOut(auth);

            // --- 資料操作 ---
            const saveItemToStorage = async (newItem) => {
                if (user && isFirebaseInitialized) {
                    let collPath = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/users/${user.uid}/items` : `users/${user.uid}/items`;
                    await setDoc(doc(db, collPath, newItem.id), newItem);
                } else {
                    setItems(prev => {
                        const exists = prev.find(i => i.id === newItem.id);
                        if (exists) return prev.map(i => i.id === newItem.id ? newItem : i);
                        return [...prev, newItem];
                    });
                }
            };

            const deleteItemFromStorage = async (itemId) => {
                if (user && isFirebaseInitialized) {
                    let collPath = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/users/${user.uid}/items` : `users/${user.uid}/items`;
                    await deleteDoc(doc(db, collPath, itemId));
                } else {
                    setItems(prev => prev.filter(i => i.id !== itemId));
                }
            };

            // --- Bulk Import Logic (支援 Excel/CSV 貼上) ---
            const handleBulkImport = () => {
                if (!importJson.trim()) return;
                
                try {
                    let parsedData = [];
                    const text = importJson.trim();

                    // 1. 嘗試解析 JSON
                    if (text.startsWith('[') || text.startsWith('{')) {
                        try {
                            const json = JSON.parse(text);
                            parsedData = Array.isArray(json) ? json : [json];
                        } catch (e) {
                            if (text.startsWith('[')) throw new Error("JSON 格式錯誤");
                        }
                    }

                    // 2. 嘗試解析 CSV/TSV
                    if (parsedData.length === 0) {
                        const rows = text.split('\n').map(r => r.trim()).filter(r => r);
                        if (rows.length < 2) throw new Error("資料過短，請包含標題列與內容");

                        const firstRow = rows[0];
                        const separator = firstRow.includes('\t') ? '\t' : ',';
                        const headers = firstRow.split(separator).map(h => h.trim().toLowerCase());
                        
                        const keyMap = {
                            'name': 'name', '名稱': 'name', '週邊名稱': 'name', '品名': 'name',
                            'character': 'character', '角色': 'character', '男主': 'character',
                            'type': 'type', '類型': 'type', '種類': 'type',
                            'series': 'series', '系列': 'series', '活動': 'series',
                            'officialprice': 'officialPrice', 'official_price': 'officialPrice', '原價': 'officialPrice', '官方原價': 'officialPrice', '價格': 'officialPrice',
                            'image': 'image', '圖片': 'image', '圖片網址': 'image', 'img': 'image'
                        };

                        const mappedHeaders = headers.map(h => keyMap[h] || h); 
                        if (!mappedHeaders.includes('name')) throw new Error("無法識別標題列，請確保包含 'name' 或 '名稱' 欄位");

                        parsedData = rows.slice(1).map(row => {
                            const values = row.split(separator);
                            const item = {};
                            mappedHeaders.forEach((key, index) => {
                                if (values[index]) {
                                    let val = values[index].trim();
                                    if (key === 'officialPrice') {
                                        val = parseInt(val.replace(/[^0-9]/g, '')) || 0;
                                    }
                                    item[key] = val;
                                }
                            });
                            return item;
                        }).filter(i => i.name);
                    }
                    
                    if (parsedData.length === 0) throw new Error("沒有有效的資料");

                    const newCatalogItems = parsedData.map(item => ({
                        ...item,
                        id: item.id || 'import_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        character: item.character || '其他',
                        type: item.type || '未分類',
                        officialPrice: item.officialPrice || 0,
                        image: item.image || null,
                        series: item.series || ''
                    }));

                    setCatalogItems(prev => [...prev, ...newCatalogItems]);

                    alert(`成功匯入 ${newCatalogItems.length} 筆資料！`);
                    setImportJson('');
                    setIsDataModalOpen(false);
                } catch (e) {
                    alert("匯入失敗：" + e.message + "\n請檢查格式是否為 JSON 或 Excel 複製內容(含標題)。");
                }
            };

            const handleExportCatalog = () => {
                const dataStr = JSON.stringify(catalogItems, null, 2);
                setImportJson(dataStr);
            };

            // --- Reset Data ---
            const handleResetData = () => {
                if (confirm("警告：這將會清空所有「收藏」與「圖鑑」的本地資料，且無法復原。\n\n確定要清空嗎？")) {
                    setItems([]);
                    setCatalogItems([]);
                    // 清除 LocalStorage
                    localStorage.removeItem('deepspace_items_v6_html');
                    localStorage.removeItem('deepspace_catalog_v1_html');
                    alert("已清空所有本地資料！");
                    setIsDataModalOpen(false);
                }
            };

            // --- Modal Actions ---
            const openModal = (item = null, template = null) => {
                const defaultData = {
                    id: Date.now().toString(),
                    name: '', character: '沈星回', type: '徽章', series: '',
                    officialPrice: '', acquiredPrice: '', date: new Date().toISOString().split('T')[0],
                    image: null, note: '', quantity: 1
                };
                if (item) { setEditingItem(item); setFormData({ ...item, quantity: 1 }); }
                else if (template) { setEditingItem(null); setFormData({ ...defaultData, ...template, quantity: 1, id: Date.now().toString() }); }
                else { setEditingItem(null); setFormData(defaultData); }
                setIsModalOpen(true);
            };

            const handleSave = async () => {
                if (!formData.name) return alert("請輸入週邊名稱");
                const qty = Math.max(1, parseInt(formData.quantity) || 1);
                
                if (editingItem) {
                    const itemToSave = { ...formData };
                    delete itemToSave.quantity;
                    await saveItemToStorage(itemToSave);
                } else {
                    for (let i = 0; i < qty; i++) {
                        const newItem = { ...formData, id: Date.now().toString() + '-' + i };
                        delete newItem.quantity;
                        await saveItemToStorage(newItem);
                    }
                }
                setIsModalOpen(false);
                if (activeTab === 'templates') setActiveTab('collection');
            };

            const handleDelete = (id) => {
                if (confirm("確定要刪除這個收藏紀錄嗎？")) deleteItemFromStorage(id);
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(prev => ({ ...prev, image: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            // --- 拖曳邏輯 ---
            const handleDragStart = (e, index, type) => {
                const currentMode = type === 'collection' ? collectionGroupingMode : groupingMode;
                if (currentMode !== 'none') { e.preventDefault(); return; }
                dragItem.current = index;
                e.target.classList.add('dragging');
                e.dataTransfer.setData('type', type);
            };
            const handleDragEnter = (e, index) => dragOverItem.current = index;
            const handleDragOver = (e) => e.preventDefault();
            const handleDragEnd = (e) => {
                e.target.classList.remove('dragging');
                const type = e.dataTransfer.getData('type');
                if (dragItem.current === null || dragOverItem.current === null) return;
                
                if (type === 'collection') {
                    const currentStacks = getStackedItems(items, 'none');
                    const movedStack = currentStacks[dragItem.current];
                    currentStacks.splice(dragItem.current, 1);
                    currentStacks.splice(dragOverItem.current, 0, movedStack);
                    setItems(currentStacks.flatMap(s => s.instances));
                } else if (type === 'catalog') {
                    const _items = [...catalogItems];
                    const moved = _items[dragItem.current];
                    _items.splice(dragItem.current, 1);
                    _items.splice(dragOverItem.current, 0, moved);
                    setCatalogItems(_items);
                }
                dragItem.current = null; dragOverItem.current = null;
            };

            // --- 統計 ---
            const stats = useMemo(() => {
                const totalCount = items.length;
                const totalSpent = items.reduce((acc, item) => acc + Number(item.acquiredPrice || 0), 0);
                const totalOfficial = items.reduce((acc, item) => acc + Number(item.officialPrice || 0), 0);
                
                const byChar = items.reduce((acc, item) => {
                    acc[item.character] = (acc[item.character] || 0) + 1;
                    return acc;
                }, {});

                return { totalCount, totalSpent, totalOfficial, byChar };
            }, [items]);

            // --- 資料處理 ---
            const getStackedItems = (sourceItems, mode) => {
                const map = new Map();
                const stacks = [];
                sourceItems.forEach(item => {
                    const key = item.name; 
                    if (!map.has(key)) {
                        const stack = { ...item, instances: [item], totalCount: 1 };
                        map.set(key, stack);
                        stacks.push(stack);
                    } else {
                        const stack = map.get(key);
                        stack.instances.push(item);
                        stack.totalCount += 1;
                    }
                });
                return stacks;
            };

            const groupedData = useMemo(() => {
                const getGrouped = (list, mode, sortOrder) => {
                    if (mode === 'none') return { '全部': list };
                    const grouped = list.reduce((acc, item) => {
                        let key = '';
                        if (mode === 'series') key = item.series || '其他系列';
                        else if (mode === 'type') key = item.type || '其他類型';
                        else if (mode === 'character') key = item.character || '其他角色';
                        else if (mode === 'date') key = item.date || '未知日期';
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(item);
                        return acc;
                    }, {});

                    if (mode === 'date') {
                        const sortedKeys = Object.keys(grouped).sort((a, b) => {
                            if (a === '未知日期') return 1;
                            if (b === '未知日期') return -1;
                            const timeA = new Date(a).getTime();
                            const timeB = new Date(b).getTime();
                            return sortOrder === 'desc' ? timeB - timeA : timeA - timeB;
                        });
                        const sortedGrouped = {};
                        sortedKeys.forEach(k => sortedGrouped[k] = grouped[k]);
                        return sortedGrouped;
                    }
                    return grouped;
                };
                return {
                    collection: getGrouped(items, collectionGroupingMode, dateSortOrder),
                    catalog: getGrouped(catalogItems, groupingMode, 'desc')
                };
            }, [items, catalogItems, groupingMode, collectionGroupingMode, dateSortOrder]);

            // --- 內部組件 ---
            const GroupingControls = ({ mode, setMode, options }) => (
                <div className="bg-white p-1 rounded-xl shadow-sm border border-gray-200 flex overflow-x-auto scrollbar-hide items-center">
                    {options.map(m => (
                        <button key={m.id} onClick={() => setMode(m.id)} className={`px-3 py-1.5 text-xs font-medium rounded-lg whitespace-nowrap flex items-center gap-1.5 transition-all ${mode === m.id ? 'bg-slate-900 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}>
                            <Icon name={m.icon} size={14} /> {m.label}
                        </button>
                    ))}
                </div>
            );

            const StackCard = ({ stack, index, isDraggable }) => {
                const theme = CHARACTER_THEMES[stack.character] || CHARACTER_THEMES["其他"];
                const consolidated = useMemo(() => {
                    const map = new Map();
                    stack.instances.forEach(inst => {
                        const key = `${inst.date}-${inst.acquiredPrice}`;
                        if (!map.has(key)) map.set(key, { ...inst, count: 1 });
                        else map.get(key).count++;
                    });
                    return Array.from(map.values());
                }, [stack.instances]);

                return (
                    <div draggable={isDraggable} onDragStart={(e) => handleDragStart(e, index, 'collection')} onDragEnter={(e) => handleDragEnter(e, index)} onDragEnd={handleDragEnd} onDragOver={handleDragOver} className={`bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all border border-gray-100 overflow-hidden flex flex-col group select-none relative ${isDraggable ? 'cursor-move' : ''}`}>
                        {stack.totalCount > 1 && <div className="absolute top-2 left-2 z-10 bg-slate-900 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">x{stack.totalCount}</div>}
                        <div className={`h-40 w-full relative bg-gray-100 flex items-center justify-center overflow-hidden`}>
                            {stack.image ? <img src={stack.image} className="w-full h-full object-cover pointer-events-none" /> : <Icon name="Image" className={`opacity-20 ${theme.text}`} size={32} />}
                            <div className="absolute top-2 right-2"><span className={`text-[10px] font-bold px-2 py-1 rounded-full bg-white/90 shadow-sm ${theme.text}`}>{stack.character}</span></div>
                        </div>
                        <div className="p-3 flex-1 flex flex-col bg-white">
                            <h3 className="font-bold text-gray-800 text-sm line-clamp-1">{stack.name}</h3>
                            <div className="flex-1 mt-1 space-y-2 overflow-y-auto max-h-[120px] thin-scrollbar pr-1">
                                {consolidated.map((inst, idx) => (
                                    <div key={idx} className="bg-gray-50 rounded p-2 text-xs border border-gray-100 flex justify-between items-center group/item">
                                        <div className="flex flex-col gap-0.5">
                                            <span className="text-gray-500 flex items-center gap-1"><Icon name="Calendar" size={10} /> {inst.date}</span>
                                            <span className="font-bold text-slate-700">NT$ {inst.acquiredPrice}</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {inst.count > 1 && <span className="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded-full">x{inst.count}</span>}
                                            <div className="flex gap-1 opacity-0 group-hover/item:opacity-100 transition-opacity">
                                                <button onClick={(e) => { e.stopPropagation(); openModal(inst); }} className="p-1 bg-white border rounded hover:text-blue-600"><Icon name="Edit3" size={10} /></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleDelete(inst.id); }} className="p-1 bg-white border rounded hover:text-red-500"><Icon name="Trash2" size={10} /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const CatalogCard = ({ item, index, isDraggable }) => {
                const theme = CHARACTER_THEMES[item.character] || CHARACTER_THEMES["其他"];
                return (
                    <div draggable={isDraggable} onDragStart={(e) => isDraggable && handleDragStart(e, index, 'catalog')} onDragEnter={(e) => isDraggable && handleDragEnter(e, index)} onDragEnd={handleDragEnd} onDragOver={handleDragOver} className={`${isDraggable ? 'cursor-move' : ''} bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-md transition-all relative`}>
                        <div className="aspect-square bg-gray-50 relative overflow-hidden">
                            <img src={item.image} alt={item.name} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 pointer-events-none" />
                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                            <button onClick={() => openModal(null, item)} className="absolute bottom-3 right-3 bg-white text-blue-600 p-2 rounded-full shadow-lg transform translate-y-10 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 hover:scale-110 cursor-pointer z-10"><Icon name="Plus" size={24} /></button>
                        </div>
                        <div className="p-3">
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`text-[10px] px-2 py-0.5 rounded-full ${CHARACTER_THEMES[item.character].badge}`}>{item.character}</span>
                                {item.type && <span className="text-[10px] text-gray-500 border border-gray-200 px-1 rounded">{item.type}</span>}
                            </div>
                            <h3 className="font-bold text-gray-800 text-sm truncate">{item.name}</h3>
                            <p className="text-xs text-gray-500 mt-1">官方參考價: NT$ {item.officialPrice}</p>
                        </div>
                    </div>
                );
            };

            // --- Render ---
            return (
                <div className="min-h-screen bg-gray-50 pb-24 md:pb-0 md:pl-64">
                    <aside className="hidden md:flex fixed left-0 top-0 h-full w-64 bg-slate-900 text-white flex-col shadow-2xl z-30">
                        <div className="p-6 border-b border-slate-800"><h1 className="text-2xl font-bold tracking-wider flex items-center gap-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400"><Icon name="Star" className="text-yellow-400" size={24} /> 深空收藏艙</h1></div>
                        <div className="px-4 py-4">
                            {user ? (
                                <div className="bg-slate-800 rounded-xl p-3 flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-lg font-bold text-white overflow-hidden">{user.photoURL ? <img src={user.photoURL} className="w-full h-full" /> : user.email[0].toUpperCase()}</div>
                                    <div className="flex-1 min-w-0"><p className="text-sm font-bold truncate">{user.displayName || '獵人'}</p><p className="text-xs text-slate-400 truncate">已連線至雲端</p></div>
                                    <button onClick={handleLogout} className="p-1.5 hover:bg-slate-700 rounded text-slate-300"><Icon name="LogOut" size={16} /></button>
                                </div>
                            ) : <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl flex items-center justify-center gap-2 font-medium transition-all"><Icon name="LogIn" size={18} /> Google 登入</button>}
                        </div>
                        <nav className="flex-1 px-4 space-y-2">
                            {['collection', 'templates', 'stats'].map(tab => <button key={tab} onClick={() => setActiveTab(tab)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === tab ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300'}`}><Icon name={tab === 'collection' ? 'Package' : tab === 'templates' ? 'ShoppingBag' : 'User'} size={20} />{tab === 'collection' ? '我的收藏庫' : tab === 'templates' ? '週邊圖鑑' : '獵人檔案'}</button>)}
                        </nav>
                        <div className="p-4 bg-slate-800"><p className="text-xs text-slate-400">總花費</p><p className="text-xl font-bold text-green-400">NT$ {stats.totalSpent.toLocaleString()}</p></div>
                    </aside>

                    <div className="md:hidden bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg flex justify-between items-center">
                        <div className="flex items-center gap-2"><Icon name="Star" className="text-yellow-400" size={20} /><span className="font-bold">深空收藏艙</span></div>
                        <div className="flex items-center gap-3"><span className="text-xs bg-slate-800 px-2 py-1 rounded border border-slate-700">{stats.totalCount} 件</span>{user ? <img src={user.photoURL} onClick={handleLogout} className="w-8 h-8 rounded-full border-2 border-blue-500" /> : <button onClick={handleLogin}><Icon name="LogIn" size={20} /></button>}</div>
                    </div>

                    <main className="p-4 md:p-8 max-w-6xl mx-auto">
                        {activeTab === 'collection' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div className="flex-1"><div className="flex items-center gap-4"><h2 className="text-2xl font-bold text-gray-800">我的收藏庫</h2><button onClick={() => openModal()} className="bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md hover:bg-slate-800 active:scale-95 text-sm"><Icon name="Plus" size={16} /> 新增紀錄</button></div></div>
                                    <div className="flex gap-2 overflow-x-auto max-w-full scrollbar-hide">
                                        {collectionGroupingMode === 'date' && <button onClick={() => setDateSortOrder(p => p === 'desc' ? 'asc' : 'desc')} className="px-3 py-1.5 text-xs font-medium rounded-lg bg-white text-blue-600 border border-blue-200 flex items-center gap-1"><Icon name={dateSortOrder === 'desc' ? 'ArrowDownNarrowWide' : 'ArrowUpNarrowWide'} size={14} /> {dateSortOrder === 'desc' ? '從新到舊' : '從舊到新'} </button>}
                                        <GroupingControls mode={collectionGroupingMode} setMode={setCollectionGroupingMode} options={[{id:'none',l:'全部'},{id:'series',l:'依系列'},{id:'type',l:'依類型'},{id:'character',l:'依角色'},{id:'date',l:'依收物日'}]} />
                                    </div>
                                </div>
                                <div className="space-y-8">
                                    {Object.entries(groupedData.collection).map(([groupName, groupRawItems]) => {
                                        const stackedItems = getStackedItems(groupRawItems, collectionGroupingMode);
                                        return <div key={groupName} className="animate-in fade-in">{collectionGroupingMode !== 'none' && <div className="flex items-center gap-2 mb-4"><div className="h-6 w-1 bg-blue-500 rounded-full"></div><h3 className="font-bold text-lg text-gray-700">{groupName}</h3><span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">{stackedItems.length} 組</span></div>}<div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">{stackedItems.map((stack, i) => <StackCard key={stack.id} stack={stack} index={i} isDraggable={collectionGroupingMode === 'none'} />)}</div></div>;
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'templates' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div><h2 className="text-2xl font-bold text-gray-800">官方週邊圖鑑</h2></div>
                                    <div className="flex gap-2 items-center">
                                        <button onClick={() => setIsDataModalOpen(true)} className="px-3 py-1.5 text-xs font-medium rounded-lg bg-blue-50 text-blue-600 border border-blue-200 flex items-center gap-1 hover:bg-blue-100"><Icon name="Database" size={14} /> 資料管理</button>
                                        <GroupingControls mode={groupingMode} setMode={setGroupingMode} options={[{id:'none',l:'全部'},{id:'series',l:'依系列'},{id:'type',l:'依類型'},{id:'character',l:'依角色'}]} />
                                    </div>
                                </div>
                                <div className="space-y-8">
                                    {Object.entries(groupedData.catalog).map(([gName, gItems]) => (
                                        <div key={gName}>
                                            {groupingMode !== 'none' && <div className="flex items-center gap-2 mb-4"><div className="h-6 w-1 bg-blue-500 rounded-full"></div><h3 className="font-bold text-lg text-gray-700">{gName}</h3></div>}
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">{gItems.map((item, idx) => <CatalogCard key={item.id} item={item} index={idx} isDraggable={groupingMode === 'none'} />)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'stats' && (
                            <div className="space-y-6 animate-fade-in">
                                <h2 className="text-2xl font-bold text-gray-800">獵人消費報告</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-slate-900 rounded-2xl p-6 text-white"><p>總投入金額</p><p className="text-3xl font-bold">NT$ {stats.totalSpent.toLocaleString()}</p></div>
                                    <div className="bg-white rounded-2xl p-6 shadow-sm col-span-2">{CHARACTERS.map(c => { if(c==="其他") return null; const count = stats.byChar[c] || 0; const pct = stats.totalCount ? (count/stats.totalCount)*100 : 0; return <div key={c} className="mb-2"><div className="flex justify-between text-sm"><span>{c}</span><span>{count}</span></div><div className="h-2 bg-gray-100 rounded"><div style={{width:`${pct}%`, background: CHARACTER_THEMES[c].bg.replace('bg-','').replace('-50','') === 'yellow' ? '#fbbf24' : '#94a3b8'}} className="h-full rounded"></div></div></div> })}</div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Import/Export Modal */}
                    {isDataModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 space-y-4">
                                <div className="flex justify-between items-center"><h3 className="text-lg font-bold">圖鑑資料管理</h3><button onClick={() => setIsDataModalOpen(false)}><Icon name="X" /></button></div>
                                <div className="bg-blue-50 p-4 rounded-xl text-sm text-blue-800"><p className="font-bold mb-1">批次匯入說明：</p><ul className="list-disc pl-4 space-y-1"><li>直接貼上 <b>Excel</b> 或 <b>Google 試算表</b> 的內容即可。</li><li>第一列必須是標題：<b>名稱</b> (必填)、角色、類型、系列、原價、圖片。</li><li>也支援貼上 JSON 格式。</li></ul></div>
                                <textarea className="w-full h-64 p-4 border rounded-xl font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="在此貼上 Excel 內容..." value={importJson} onChange={(e) => setImportJson(e.target.value)}></textarea>
                                <div className="flex gap-2">
                                    <button onClick={handleBulkImport} className="flex-1 bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 font-medium">確認匯入</button>
                                    <button onClick={handleExportCatalog} className="px-6 py-3 border border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50 font-medium">匯出備份</button>
                                </div>
                                <button onClick={handleResetData} className="w-full bg-red-50 text-red-600 border border-red-200 py-3 rounded-xl hover:bg-red-100 font-medium mt-4 flex items-center justify-center gap-2">
                                    <Icon name="Trash2" size={16} /> ⚠️ 清空重置所有資料
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Add/Edit Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 space-y-4">
                                <h3 className="text-lg font-bold">{editingItem ? '編輯收藏' : '加入收藏'}</h3>
                                <div onClick={() => fileInputRef.current.click()} className="w-32 h-32 mx-auto border-2 border-dashed rounded-xl flex items-center justify-center cursor-pointer">
                                    {formData.image ? <img src={formData.image} className="w-full h-full object-cover rounded-xl" /> : <Icon name="Upload" className="text-gray-400" />}
                                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleImageUpload} />
                                </div>
                                <input className="w-full p-2 border rounded" placeholder="名稱" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                <div className="grid grid-cols-2 gap-4">
                                    <select className="p-2 border rounded" value={formData.character} onChange={e => setFormData({...formData, character: e.target.value})}>{CHARACTERS.map(c=><option key={c}>{c}</option>)}</select>
                                    <input className="p-2 border rounded" placeholder="類型" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <input type="number" className="p-2 border rounded" placeholder="入手價" value={formData.acquiredPrice} onChange={e => setFormData({...formData, acquiredPrice: e.target.value})} />
                                    <input type="date" className="p-2 border rounded" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                </div>
                                {!editingItem && (
                                    <div className="flex items-center gap-2">
                                        <label>數量:</label>
                                        <button onClick={()=>setFormData(p=>({...p, quantity: Math.max(1, p.quantity-1)}))} className="p-1 bg-gray-100 rounded"><Icon name="Minus" size={14}/></button>
                                        <span>{formData.quantity}</span>
                                        <button onClick={()=>setFormData(p=>({...p, quantity: p.quantity+1}))} className="p-1 bg-gray-100 rounded"><Icon name="Plus" size={14}/></button>
                                    </div>
                                )}
                                <div className="flex gap-2">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 p-3 bg-gray-100 rounded">取消</button>
                                    <button onClick={handleSave} className="flex-1 p-3 bg-slate-900 text-white rounded">儲存</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Mobile Nav */}
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t p-2 flex justify-around z-40">
                        <button onClick={()=>setActiveTab('collection')}><Icon name="Package" /><span className="text-xs block">收藏</span></button>
                        <button onClick={()=>setActiveTab('templates')}><Icon name="ShoppingBag" /><span className="text-xs block">圖鑑</span></button>
                        <button onClick={()=>setActiveTab('stats')}><Icon name="User" /><span className="text-xs block">檔案</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
